# Документация по миграциям (Migrations) в DODO

## Содержание

1. [Введение](#введение)
2. [Архитектура](#архитектура)
3. [Основные типы миграций](#основные-типы-миграций)
4. [DODO-специфичные миграции](#dodo-специфичные-миграции)
5. [Техническая реализация](#техническая-реализация)
6. [Процесс миграции](#процесс-миграции)

## Введение

Модуль `migrations` содержит скрипты миграции базы данных Superset, которые используются для обновления схемы базы данных при обновлении версии Superset. Миграции реализованы с использованием библиотеки Alembic, которая является стандартным инструментом миграции для приложений на базе SQLAlchemy.

В DODO этот модуль используется для управления схемой базы данных и добавления DODO-специфичных таблиц и полей, необходимых для работы функциональности DODO.

## Архитектура

Модуль `migrations` организован следующим образом:

1. **Основные файлы**:
   - `alembic.ini` - конфигурационный файл Alembic
   - `env.py` - скрипт окружения Alembic
   - `script.py.mako` - шаблон для генерации новых миграций
   - `migration_utils.py` - утилиты для миграций

2. **Папки**:
   - `versions` - содержит все скрипты миграции
   - `shared` - содержит общие утилиты и функции для миграций

3. **Версии миграций**:
   - Каждый файл в папке `versions` представляет собой отдельную миграцию
   - Имена файлов содержат дату, время и идентификатор миграции
   - Каждая миграция имеет функции `upgrade()` и `downgrade()`

## Основные типы миграций

В Superset используются следующие основные типы миграций:

1. **Структурные миграции**:
   - Добавление новых таблиц
   - Добавление новых колонок в существующие таблицы
   - Изменение типов данных колонок
   - Добавление или удаление индексов и ограничений

2. **Миграции данных**:
   - Преобразование данных из одного формата в другой
   - Заполнение новых колонок данными из существующих
   - Очистка или нормализация данных

3. **Миграции визуализаций**:
   - Обновление параметров визуализаций
   - Преобразование устаревших типов визуализаций в новые

## DODO-специфичные миграции

В DODO были добавлены несколько специфичных миграций для поддержки функциональности, необходимой для работы DODO. Основные DODO-специфичные миграции:

1. **Миграция для онбординга пользователей** (dbe6e308abc8):
   - Добавлены поля для отслеживания процесса онбординга пользователей
   - Добавлено в рамках задачи #32839638
   - Добавлены поля: `is_onboarding_finished`, `onboarding_started_time`, `dodo_role`

   ```python
   # DODO was here
   # DODO added #32839638
   """empty message

   Revision ID: dbe6e308abc8
   Revises: f1ce55d13dfb
   Create Date: 2023-11-01 04:00:00.000000

   """

   # revision identifiers, used by Alembic.
   revision = "dbe6e308abc8"
   down_revision = "f1ce55d13dfb"

   import sqlalchemy as sa  # noqa: E402
   from alembic import op  # noqa: E402


   def upgrade():
       # ### commands auto generated by Alembic - please adjust! ###
       op.add_column(
           "user_info", sa.Column("is_onboarding_finished", sa.Boolean(), nullable=True)
       )
       op.add_column(
           "user_info", sa.Column("onboarding_started_time", sa.DateTime(), nullable=True)
       )
       op.add_column(
           "user_info", sa.Column("dodo_role", sa.String(length=32), nullable=True)
       )
       # ### end Alembic commands ###
   ```

2. **Миграция для авторизации данных** (3c0ff4a543a6):
   - Добавлены поля для хранения информации о доступе к данным
   - Добавлены поля: `data_auth_dodo`, `country_num`, `country_name`

   ```python
   def upgrade():
       # ### commands auto generated by Alembic - please adjust! ###
       op.add_column(
           "user_info",
           sa.Column(
               "data_auth_dodo",
               sa.Text().with_variant(mysql.MEDIUMTEXT(), "mysql"),
               nullable=True,
           ),
       )
       op.add_column("user_info", sa.Column("country_num", sa.Integer(), nullable=True))
       op.add_column("user_info", sa.Column("country_name", sa.String(), nullable=True))
       op.add_column("logs", sa.Column("is_plugin", sa.Boolean(), nullable=True))
       # ### end Alembic commands ###
   ```

3. **Модификация последовательности миграций** (b7851ee5522f):
   - Изменение последовательности миграций для поддержки DODO-специфичных миграций
   - Добавлено в рамках задачи #44994244

   ```python
   # revision identifiers, used by Alembic.
   revision = "b7851ee5522f"
   down_revision = "2684073d82a4"  # DODO added 44994244
   ```

Эти миграции позволяют DODO расширять функциональность Superset, добавляя новые поля и таблицы, необходимые для работы специфичных для DODO функций.

## Техническая реализация

### Структура миграционного файла

Каждый миграционный файл имеет следующую структуру:

```python
# revision identifiers, used by Alembic.
revision = "идентификатор_миграции"
down_revision = "идентификатор_предыдущей_миграции"

import sqlalchemy as sa
from alembic import op

def upgrade():
    # Код для обновления схемы базы данных
    pass

def downgrade():
    # Код для отката изменений
    pass
```

### Добавление новой таблицы

```python
def upgrade():
    op.create_table(
        "new_table",
        sa.Column("id", sa.Integer(), nullable=False),
        sa.Column("name", sa.String(length=255), nullable=False),
        sa.Column("created_on", sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )

def downgrade():
    op.drop_table("new_table")
```

### Добавление новой колонки

```python
def upgrade():
    op.add_column("table_name", sa.Column("new_column", sa.String(length=255), nullable=True))

def downgrade():
    op.drop_column("table_name", "new_column")
```

### Изменение данных

```python
def upgrade():
    bind = op.get_bind()
    session = db.Session(bind=bind)

    for item in session.query(Model).all():
        # Изменение данных
        item.new_column = transform(item.old_column)

    session.commit()
    session.close()
```

## Процесс миграции

Процесс миграции базы данных в DODO включает следующие шаги:

1. **Создание новой миграции**:
   - Использование команды `superset db migrate` для создания новой миграции
   - Редактирование созданного файла для добавления необходимых изменений

2. **Применение миграции**:
   - Использование команды `superset db upgrade` для применения всех новых миграций
   - Проверка корректности применения миграций

3. **Откат миграции (при необходимости)**:
   - Использование команды `superset db downgrade` для отката миграций
   - Указание идентификатора миграции, до которой нужно откатиться

4. **Проверка состояния миграций**:
   - Использование команды `superset db current` для проверки текущей версии базы данных
   - Использование команды `superset db history` для просмотра истории миграций

### Пример создания новой миграции

```bash
# Создание новой миграции
superset db migrate -m "add_new_column_to_table"

# Применение миграции
superset db upgrade

# Откат миграции
superset db downgrade идентификатор_предыдущей_миграции
```

### Пример DODO-специфичной миграции

Для добавления новой DODO-специфичной миграции необходимо:

1. Создать новый файл миграции с помощью команды `superset db migrate`
2. Отредактировать файл, добавив необходимые изменения
3. Добавить комментарий с указанием номера задачи DODO
4. Применить миграцию с помощью команды `superset db upgrade`

```python
# DODO added #номер_задачи
"""описание_миграции

Revision ID: идентификатор_миграции
Revises: идентификатор_предыдущей_миграции
Create Date: дата_создания

"""

# revision identifiers, used by Alembic.
revision = "идентификатор_миграции"
down_revision = "идентификатор_предыдущей_миграции"

import sqlalchemy as sa
from alembic import op

def upgrade():
    # Код для обновления схемы базы данных
    op.add_column("table_name", sa.Column("dodo_specific_column", sa.String(length=255), nullable=True))

def downgrade():
    # Код для отката изменений
    op.drop_column("table_name", "dodo_specific_column")
```
