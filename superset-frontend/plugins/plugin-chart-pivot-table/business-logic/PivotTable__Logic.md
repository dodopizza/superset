# Документация бизнес-логики для Pivot Table в Superset

## Назначение
Pivot Table предоставляет функциональность сводных таблиц с возможностью:
- Группировки данных по строкам и столбцам
- Агрегации значений по различным метрикам
- Настройки форматов отображения
- Кастомных модификаций DODO

## Основные параметры
- **groupbyRows** - Колонки для группировки по строкам
- **groupbyColumns** - Колонки для группировки по столбцам
- **metrics** - Метрики для агрегации
- **aggregateFunction** - Функция агрегации (Sum, Average, Count и др.)
- **transposePivot** - Транспонировать таблицу
- **valueFormat** - Формат чисел по умолчанию
- **currencyFormat** - Формат валюты
- **emitCrossFilters** - Включить кросс-фильтрацию
- **columnConfig** - Конфигурация колонок (DODO 45525377)
- **pinnedColumns** - Закрепленные колонки (DODO 45525377)
- **datasourceMetrics** - Метрики источника данных (DODO 44211769)
- **datasourceDescriptions** - Описания источников (DODO 44728892)

## Логика работы
1. **Подготовка данных**:
   - Преобразование в "unpivoted" формат для работы с метриками
   - Применение группировки по строкам и столбцам
   - Обработка параметров транспонирования

2. **Агрегация**:
   - Применение выбранной функции агрегации
   - Расчет итогов и промежуточных итогов
   - Сортировка значений

3. **Форматирование**:
   - Применение числовых форматов
   - Обработка валютных значений
   - Кастомные форматы для колонок (DODO 44211769)

## Форматирование и отображение
1. **Форматирование значений**:
   - Стандартные числовые форматы (d3-format)
   - Валютные форматы
   - Кастомные форматы на уровне колонок (DODO 44211769)

2. **Визуальные настройки**:
   - Позиционирование итогов
   - Иконки развертывания/свертывания
   - Подсветка заголовков
   - Закрепление колонок (DODO 45525377)

## Особенности DODO
1. **Дополнительные параметры**:
   - columnConfig: Позволяет задавать d3NumberFormat, агрегацию и видимость для каждой колонки (DODO 45525377)
   - pinnedColumns: Закрепляет указанные колонки (DODO 45525377)
   - datasourceMetrics: Используется для получения форматов чисел из источника (DODO 44211769)
   - datasourceDescriptions: Добавляет описания к данным (DODO 44728892)

2. **Улучшенная логика**:
   - Приоритет форматов из columnConfig над глобальными (DODO 44211769)
   - Поддержка скрытия значений в итогах (DODO 45525377)
   - Расширенная обработка метаданных источников (DODO 44728892)

## Примеры конфигурации
```json
{
  "groupbyRows": ["department"],
  "groupbyColumns": ["year"],
  "metrics": ["sales"],
  "aggregateFunction": "Sum",
  "valueFormat": "$,.2f",
  "columnConfig": {
    "sales": {
      "d3NumberFormat": "$,.0f",
      "pinColumn": true
    }
  },
  "pinnedColumns": [0]
}
```

## Референсы
1. **Файлы реализации**:
   - Основной компонент: `PivotTableChart.tsx`
   - Типы: `types.ts`
   - Утилиты: `DodoExtensions/`
   - Шаблон React-PivotTable: `react-pivottable/`

2. **Связанные компоненты**:
   - Фильтры
   - Форматы чисел
   - Источники данных

## Примечания
- Все DODO-модификации помечены соответствующими номерами ревизий
- Форматы из columnConfig имеют приоритет над глобальными настройками
- Закрепленные колонки остаются видимыми при горизонтальной прокрутке
