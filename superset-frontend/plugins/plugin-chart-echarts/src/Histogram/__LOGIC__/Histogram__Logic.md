# Бизнес-логика графика: Histogram (Гистограмма)

## Общее описание

Histogram (Гистограмма) - это тип визуализации, который отображает распределение набора данных путем представления частоты или количества значений в различных диапазонах или бинах. Гистограмма помогает визуализировать паттерны, кластеры и выбросы в данных, а также предоставляет информацию о форме, центральной тенденции и разбросе данных. Этот тип графика особенно полезен для анализа распределения числовых данных.

## Основные параметры и их назначение

### Параметры запроса (Query)

| Параметр        | Назначение                                  | Подтверждение в коде                                     |
| --------------- | ------------------------------------------- | -------------------------------------------------------- |
| `column`        | Числовой столбец для построения гистограммы | [controlPanel.tsx](../controlPanel.tsx): `column`        |
| `groupby`       | Столбцы для группировки данных              | [controlPanel.tsx](../controlPanel.tsx): `groupby`       |
| `adhoc_filters` | Фильтры для данных                          | [controlPanel.tsx](../controlPanel.tsx): `adhoc_filters` |
| `row_limit`     | Ограничение количества строк                | [controlPanel.tsx](../controlPanel.tsx): `row_limit`     |
| `bins`          | Количество бинов (столбцов) гистограммы     | [controlPanel.tsx](../controlPanel.tsx): `bins`          |

### Параметры отображения (Chart Options)

| Параметр       | Назначение                         | Подтверждение в коде                                         |
| -------------- | ---------------------------------- | ------------------------------------------------------------ |
| `color_scheme` | Цветовая схема для графика         | [controlPanel.tsx](../controlPanel.tsx): `color_scheme`      |
| `show_value`   | Отображение значений над столбцами | [controlPanel.tsx](../controlPanel.tsx): `showValueControl`  |
| `show_legend`  | Отображение легенды                | [controlPanel.tsx](../controlPanel.tsx): `showLegendControl` |
| `normalize`    | Нормализация данных (в процентах)  | [controlPanel.tsx](../controlPanel.tsx): `normalize`         |
| `cumulative`   | Кумулятивная гистограмма           | [controlPanel.tsx](../controlPanel.tsx): `cumulative`        |
| `x_axis_title` | Заголовок оси X                    | [types.ts](../types.ts): `xAxisTitle`                        |
| `y_axis_title` | Заголовок оси Y                    | [types.ts](../types.ts): `yAxisTitle`                        |

## Логика работы и обработки данных

### Основной поток данных

1. **Получение данных**: Данные получаются из источника данных через API запрос.
2. **Постобработка данных**: Данные обрабатываются с помощью оператора гистограммы.
   - В файле [buildQuery.ts](../buildQuery.ts) используется `histogramOperator` из `@superset-ui/chart-controls` для постобработки данных.
   - Оператор гистограммы разбивает данные на указанное количество бинов и рассчитывает частоту значений в каждом бине.
3. **Трансформация данных**: Данные преобразуются в формат, подходящий для гистограммы.
   - В файле [transformProps.ts](../transformProps.ts) происходит преобразование данных из формата запроса в формат, необходимый для компонента ECharts.
   - Для каждой группы (если указаны параметры группировки) создается отдельная серия данных.
4. **Форматирование данных**: Данные форматируются в зависимости от параметров нормализации и кумулятивности.
   - Если включена нормализация, значения представляются в процентах от общего количества.
   - Если включена кумулятивность, значения представляют собой накопленную сумму частот.
5. **Отображение**: Данные отображаются в виде гистограммы с использованием библиотеки ECharts.

### Расчет бинов

Параметр `bins` определяет количество столбцов (бинов) в гистограмме. Алгоритм работает следующим образом:

1. Определяется минимальное и максимальное значение в данных.
2. Диапазон между минимальным и максимальным значением разбивается на указанное количество равных интервалов (бинов).
3. Для каждого бина рассчитывается количество значений, попадающих в его диапазон.

Оператор `histogramOperator` в [buildQuery.ts](../buildQuery.ts) отвечает за этот расчет.

### Нормализация и кумулятивность

- **Нормализация** (`normalize`): Если включена, значения представляются в процентах от общего количества. Это позволяет сравнивать распределения разного размера.
- **Кумулятивность** (`cumulative`): Если включена, значения представляют собой накопленную сумму частот. Это позволяет увидеть, как данные накапливаются по мере увеличения значений.

## Форматирование и визуальные настройки

### Форматирование значений

- **Формат чисел**: Если включена нормализация, используется формат с двумя десятичными знаками (FLOAT_2_POINT). В противном случае используется целочисленный формат (INTEGER).
- **Формат процентов**: Для отображения процентов используется формат с двумя десятичными знаками (PERCENT_2_POINT).

### Настройки осей

- **Заголовки осей**: Параметры `xAxisTitle` и `yAxisTitle` определяют заголовки осей X и Y соответственно.
- **Метки осей**: Метки оси X соответствуют границам бинов. Метки оси Y форматируются в соответствии с выбранным форматом чисел.

### Настройки легенды

- **Отображение легенды**: Параметр `showLegend` определяет, отображается ли легенда.
- **Тип легенды**: Используется тип легенды `scroll`, который позволяет прокручивать легенду при большом количестве серий.
- **Ориентация легенды**: Используется ориентация легенды `top`, которая размещает легенду в верхней части графика.

## Примеры конфигурации в JSON

### Пример 1: Базовая гистограмма

```json
{
  "datasource": "5__table",
  "viz_type": "echarts_histogram",
  "slice_id": 123,
  "column": "age",
  "groupby": [],
  "adhoc_filters": [],
  "row_limit": 10000,
  "bins": 10,
  "color_scheme": "supersetColors",
  "show_value": true,
  "show_legend": false,
  "normalize": false,
  "cumulative": false,
  "x_axis_title": "Возраст",
  "y_axis_title": "Количество"
}
```

### Пример 2: Нормализованная гистограмма с группировкой

```json
{
  "datasource": "5__table",
  "viz_type": "echarts_histogram",
  "slice_id": 123,
  "column": "salary",
  "groupby": ["department"],
  "adhoc_filters": [
    {
      "clause": "WHERE",
      "expressionType": "SIMPLE",
      "filterOptionName": "filter_8ly71emic_hc9vt9a6i7",
      "comparator": "2023-01-01",
      "operator": ">=",
      "subject": "hire_date"
    }
  ],
  "row_limit": 10000,
  "bins": 15,
  "color_scheme": "d3Category20",
  "show_value": false,
  "show_legend": true,
  "normalize": true,
  "cumulative": false,
  "x_axis_title": "Зарплата",
  "y_axis_title": "Процент"
}
```

### Пример 3: Кумулятивная гистограмма

```json
{
  "datasource": "5__table",
  "viz_type": "echarts_histogram",
  "slice_id": 123,
  "column": "order_value",
  "groupby": ["customer_segment"],
  "adhoc_filters": [],
  "row_limit": 10000,
  "bins": 20,
  "color_scheme": "supersetColors",
  "show_value": true,
  "show_legend": true,
  "normalize": false,
  "cumulative": true,
  "x_axis_title": "Стоимость заказа",
  "y_axis_title": "Накопленное количество"
}
```

## Пути к файлам реализации

- **Основной компонент**: [superset-frontend/plugins/plugin-chart-echarts/src/Histogram/Histogram.tsx](../Histogram.tsx)
- **Трансформация данных**: [superset-frontend/plugins/plugin-chart-echarts/src/Histogram/transformProps.ts](../transformProps.ts)
- **Конфигурация**: [superset-frontend/plugins/plugin-chart-echarts/src/Histogram/controlPanel.tsx](../controlPanel.tsx)
- **Типы данных**: [superset-frontend/plugins/plugin-chart-echarts/src/Histogram/types.ts](../types.ts)
- **Построение запроса**: [superset-frontend/plugins/plugin-chart-echarts/src/Histogram/buildQuery.ts](../buildQuery.ts)

## Примечания

- Histogram использует библиотеку ECharts для визуализации данных.
- Для расчета бинов используется оператор `histogramOperator` из `@superset-ui/chart-controls`.
- Параметр `normalize` позволяет представить данные в процентах от общего количества, что полезно для сравнения распределений разного размера.
- Параметр `cumulative` позволяет увидеть, как данные накапливаются по мере увеличения значений.
- При включенной нормализации ось Y отображает проценты, а при выключенной - абсолютные значения.
- При изменении логики этого плагина необходимо обновить соответствующие функции в `transformProps.ts` и `buildQuery.ts`.
- Гистограмма поддерживает группировку данных, что позволяет сравнивать распределения для разных групп на одном графике.
