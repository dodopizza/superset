# Документация бизнес-логики для Pie-графика Superset

## Назначение
Pie-график (круговой график) отображает пропорциональное распределение данных по категориям. Поддерживает:
- Обычный pie и donut варианты
- Настройку отображения меток
- Форматирование значений
- Nightingale chart (розовидный график)
- DODO-специфичные модификации

## Основные параметры
- **groupby** - столбец для группировки данных
- **metric** - метрика для отображения
- **donut** - отображать как donut (true/false)
- **innerRadius** - внутренний радиус для donut (0-100)
- **outerRadius** - внешний радиус (10-100)
- **showLabels** - показывать метки (true/false)
- **labelType** - тип отображаемых меток (значение, процент, комбинации)
- **roseType** - тип розовидного графика (area/radius/none)
- **showTotal** - показывать общее значение (DODO-модификация)

## Логика работы
1. **Преобразование данных**:
   - Группировка данных по указанному столбцу
   - Расчет значений для каждой категории
   - Форматирование значений согласно настройкам

2. **Обработка DODO-специфичных особенностей**:
   ```typescript
   // DODO changed 45525377 - динамический расчет ширины легенды
   const LEGEND_WIDTH = valueToShow.length * 7.47;
   
   // DODO added 45525377 - улучшенное отображение общего значения
   const totalText = t('Total: %s', numberFormatter(totalValue));
   ```

## Форматирование и отображение
1. **Форматирование значений**:
   - Поддержка числовых форматов (D3 format)
   - Форматирование валют
   - Форматирование дат

2. **Визуальные настройки**:
   - Цветовая схема (из палитры Superset)
   - Положение меток (внутри/снаружи)
   - Минимальный угол для отображения метки
   - Настройка радиуса и формы

## Особенности DODO
1. **Дополнительные параметры**:
   - `showTotal` - отображение общего значения в центре графика
   - Динамический расчет ширины легенды на основе длины текста

2. **Улучшенная логика**:
   - Оптимизированное позиционирование общего значения
   - Более точный расчет места для элементов

Пример конфигурации:
```json
{
  "donut": true,
  "innerRadius": 30,
  "outerRadius": 80,
  "showLabels": true,
  "labelType": "key_value_percent",
  "showTotal": true,
  "roseType": null
}
```

## Примеры использования
1. **Обычный pie-график**:
   - Показывает распределение по категориям
   - Метки с названиями и процентами

2. **Donut с общим значением** (DODO):
   - Кольцевая диаграмма
   - Общее значение в центре
   - Динамическое позиционирование

3. **Nightingale chart**:
   - Розовидная диаграмма
   - Варианты area/radius

## Референсы
1. **Файлы реализации**:
   - Основной компонент: `superset-frontend/plugins/plugin-chart-echarts/src/Pie/EchartsPie.tsx`
   - Конфигурация: `superset-frontend/plugins/plugin-chart-echarts/src/Pie/controlPanel.tsx`
   - Логика преобразования: `superset-frontend/plugins/plugin-chart-echarts/src/Pie/transformProps.ts`

2. **Связанные компоненты**:
   - Базовый ECharts компонент
   - Цветовые схемы Superset
   - Система форматирования значений

## Примечания
- Для DODO-версии обязательно использование параметра `showTotal`
- Ширина легенды рассчитывается автоматически на основе длины текста
- Все DODO-модификации помечены соответствующими комментариями в коде
